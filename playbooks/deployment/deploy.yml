---
# Create a Capistrano-like structure

- hosts: all
  sudo_user: stld
  sudo: yes
  tasks:
  - name: Create a timestamp
    command: "date +%s"
    register: timestamp

  - name: Pull from git
    git: repo=https://github.com/ostapneko/stld
         dest=${app_root}/releases/${timestamp.stdout}

  - name: Destroy link to previous release
    file: path=$app_root/current state=absent

  - name: Link to current release
    file: path=${app_root}/current state=link
          src=${app_root}/releases/${timestamp.stdout}

  - name: Link database.yml
    file: path=${app_root}/current/config/database.yml state=link
          src=${app_root}/shared/config/database.yml

  - name: Link unicorn.rb
    file: path=${app_root}/current/config/unicorn.rb state=link
          src=${app_root}/shared/config/unicorn.rb

  - name: Link log directory
    file: path=${app_root}/current/log
          state=link
          src=/var/log/stld

  - name: update bundle
    shell: bundle
           chdir=${app_root}/current
    environment: $ruby_env

  - name: Run sequel migrations
    shell: bundle exec ruby script/migrate.rb
           chdir=${app_root}/current
    environment: $ruby_env

  - name: Compile assets
    shell: /usr/bin/coffee --compile --output public/js public/coffee
           chdir=${app_root}/current

- hosts: all
  sudo: yes
  tasks:
  - name: Get unicorn PID
    command: cat {{ app_root }}/shared/pids/unicorn.pid
    register: unicorn_pid
    ignore_errors: true
  - name: start unicorn
    command: /sbin/start stld
    when: unicorn_pid|failed
  - name: Kill unicorn
    command: kill {{ unicorn_pid.stdout }}
    when: unicorn_pid|success
